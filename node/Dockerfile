# syntax=docker/dockerfile:1.7
################################################################################
# BUILDER IMAGE
################################################################################
FROM node:20-buster-slim AS build

# Keep npm from reading any baked-in .npmrc in the image
ENV NPM_CONFIG_USERCONFIG=/tmp/empty-npmrc

# Workdir
WORKDIR /app

# Install deps with only the manifests for better caching
COPY package*.json ./

# Make sure we talk to the public registry (and nothing else)
RUN npm config set registry https://registry.npmjs.org/ \
 && npm config delete '//npm.pkg.github.com/:_authToken' || true \
 && npm config list \
 && npm ci --no-audit --fund=false

# Now copy the rest of the app
COPY . .

# Build step (optional if your app needs it)
# RUN npm run build

# ------------------------------------------------------------------------------
# RUNTIME STAGE (optional; keeps image small)
# ------------------------------------------------------------------------------
FROM node:20-buster-slim

WORKDIR /app

# Copy node_modules and source from build stage
COPY --from=build /app /app

EXPOSE 3000
CMD ["npm", "start"]